

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>销售管理-销售机会-新增</title>
    <style type="text/css">
        .form-group
        {
            margin-top: 3.7%;
        }
    </style>
    <script src="../resource/js/bootstrap-LeadInto.js" type="text/javascript" charset="utf-8"></script>
    
</head>
<% 
    
    salesManagePageListDao salesManagePageListDao = new salesManagePageListDao();
    List<string> clientManagerList = salesManagePageListDao.QueryClientManager();
    int lastno = int.Parse(Session["lastoptno"].ToString());
    string createname = (string)Session["username"];
    salesManageAddDao salesManageAddDao = new salesManageAddDao();
    List<CstNameLink> allCompanyNameNo = salesManageAddDao.AllCompanyNameList();
%>
<body>
 <form id="form11" method="post"  onsubmit="return check()" action="../../Control/salesManageControl/salesManageAddHandler.ashx?methodid=savetable"
    class="form-horizontal center-block" role="form">
    <div class="col-md-12 column">
        <div class="col-sm-2 column col-sm-offset-9">
            <button type="submit" class="btn btn-default btn-block btn-primary" style="margin-top: 10%;
                margin-bottom: 0;">
                保存</button>
        </div>
    </div>
    <div class="col-sm-9 column col-sm-offset-1">
        <div class="form-group" style="margin-top: 2%;">
            <label for="inputEmail3" class="col-sm-2 control-label">
                关系编号</label>
            <div class="col-sm-4">
                <input name="optno" type="text" class="form-control" value="<%=lastno+2%>" readonly="readonly"
                    id="inputEmail3" />
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                机会来源</label>
            <div class="col-sm-4">
                <input name="optsource" required="required" type="text" class="form-control" id="inputEmail3" />
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                客户公司</label>
            <div class="col-sm-4">
                <%--<input type="hidden" name="optsctnametext" id="optsctnametext"/> --%>
                <select name="optsctname" class="form-control" id="optsctname">
                    <option>请选择公司</option>
                      <% for (int i = 0; i <allCompanyNameNo.Count; i++)
                       {%>
                       <option value="<%=allCompanyNameNo[i].CstNo %>"><%=allCompanyNameNo[i].CstName%></option>
                   <%  } %>
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                成功概率</label>
            <div class="col-sm-4">
                <input type="text" name="optrate" maxlength="2" onkeyup="value=value.replace(/[^\d]/g,'')" required="required"  class="form-control" id="optrate" />
            </div>
        </div>
        <div class="form-group">
            <label for="inputPassword3" class="col-sm-2 control-label">
                需求概要</label>
            <div class="col-sm-10">
                <textarea name="optsummary" required class="form-control" rows="3" style="resize: none;"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                联系人员</label>
            <div class="col-sm-4">
                <select name="optlkmname" id="optlkmname" class="form-control">
                    <option grade="1" id="selectcompany" value="请选择公司">请选择公司</option>
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                联系电话</label>
            <div class="col-sm-4">
                <input name="optlkmtel" value="请选择公司" id="optlkmtel" readonly="readonly" type="text" class="form-control" />
            </div>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="inputEmail3" required="required" class="col-sm-2 control-label">
                人员职位</label>
            <div class="col-sm-4">
                <input name="optlkmposition" required="required" type="text" class="form-control" id="Text2" />
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                联系备注</label>
            <div class="col-sm-4">
                <input value="请选择公司" type="text" readonly="readonly" class="form-control" id="optremark" />
            </div>
        </div>
        <div class="form-group">
            <label for="inputPassword3" class="col-sm-2 control-label">
                机会描述</label>
            <div class="col-sm-10">
                <textarea name="optdesc" required class="form-control" rows="3" style="resize: none;"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                创建人员</label>
            <div class="col-sm-4">
                <input name="optcreatename" readonly="readonly" value="<%=createname %>" type="text"
                    class="form-control" id="inputEmail3" />
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                创建日期</label>
            <div class="col-sm-4">
                <input name="optcreatedate" type="date" readonly="readonly" class="form-control" id="startdata" />
            </div>
        </div>
        <ul class="nav nav-list">
            <li class="divider"></li>
        </ul>
        <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">
                指派人员</label>
            <div class="col-sm-4">
                <select name="optduename" id="duename" class="form-control">
                    <option>空</option>
                    <% for (int i = 0; i < clientManagerList.Count; i++)
                       {
                    %>
                    <option value="<%=clientManagerList[i] %>">
                        <%=clientManagerList[i] %></option>
                    <% } %>
                </select>
            </div>
            <label for="inputEmail3" class="col-sm-2 control-label">
                指派日期</label>
            <div class="col-sm-4">
                <input name="optduedate" id="duedate" type="text" class="form-control" readonly="readonly"
                    id="distributedata" />
            </div>
        </div>
    </div>
    </form>
    <script >
        function getObj(id) {
            var Obj = document.getElementById(id).value;
            return Obj;
        }
        function check() {
            if (getObj("optlkmtel") == "暂无联系电话" || getObj("optlkmtel") == "请选择公司") {
                alert("暂无联系人数据，无法提交！");
                document.getElementById("optlkmtel").focus;
                return false; //false:阻止提交表单 
            }
            var value = document.getElementById("optrate").value;
            var reg = /^\d+$/;
            if (reg.test(value) == true) {
                return true;
            } else {
                alert("提交失败!成功概率必须为纯数字");
                return false;
            }
        }
        var list;
        window.onload = function aaaaaaaa() {
            document.getElementById('startdata').valueAsDate = new Date();
            $.ajax({
                cache: true,
                type: "POST",
                url: "../../Control/salesManageControl/salesManageGetAddMsgHandler.ashx",
                data: $('#form1').serialize(),
                async: false,
                error: function(requset) {
                    alert("nono");
                },
                success: function(data) {
           
                    list = JSON.parse(data);
                    for (var i = 0; i < list.length; i++) {
                        if (i !== 0 && list[i].CstName === list[i - 1].CstName) {
                            continue;
                        }
                        // $("#optsctname").append("<option>" + list[i].CstName + "</option>");
                    }
                }
            });
           
           
            $("#optsctname").change(function () {
                var isFirst = 0;
               // $("#optsctnametext").attr("value",$("#optsctname").val());
                $("#optlkmname").empty();
                var name = $("#optsctname").val();
                // alert(name);
                for (var i = 0; i < list.length; i++) {
                    if (list[i].CstNo == name) {
                       // alert(list[i].CstNo);
                        //("#optlkmname").append("<option>" + list[i].LkmName + "</option>");
                        if (isFirst === 0) {
                            isFirst = i;
                        }
                        $("#optlkmname").append("<option>" + list[i].LkmName + "</option>");
                        $("#optlkmtel").val(list[isFirst].LkmTel);
                        $("#optremark").val(list[isFirst].LkmRemark);
                     //   alert();
                    }
     
                }
                if ($("#optsctname").val() === '请选择公司') {
                    // alert($("#optlkmtel").val());
                    $("#optlkmname").append("<option>请选择公司</option>");
                    $("#optlkmtel").val('请选择公司');
                    $("#optremark").val('请选择公司');
                }
                if ($("#optlkmname").val() == null) {
                    $("#optlkmname").append("<option>暂无联系人</option>");
                    $("#optlkmtel").val('暂无联系电话');
                    $("#optremark").val('暂无备注');
                }
               
//                if ($("#optlkmtel").val('请选择公司');) {
//                    
//                }
            });
            $("#optlkmname").change(function() {
                $("#optlkmtel").empty();
                var name = $("#optlkmname").val();
                for (var i = 0; i < list.length; i++) {
                    if (list[i].LkmName === name) {
                        $("#optlkmtel").val(list[i].LkmTel);
                        $("#optremark").val(list[i].LkmRemark);
                    }
                }
            });
            $("#duename ").change(function() {
                    var a = $("#duename ").val();
                    if ($("#duename ").val() === '空') {
                        $("#duedate").attr("type", "text");
                        $("#duedate").val("");
                    } else {
                        var data = new Date().format("yyyy-MM-dd");
                        var dataArry = data.split("-");
                        data = "";
                        for (var i = 0; i < dataArry.length; i++) {

                            if (i == 2)
                                data += dataArry[i];
                            else {
                                data += dataArry[i] + "/";
                            }
                        }
                        $("#duedate").val(data);
                    }
                }
            );
            Date.prototype.format = function(fmt) {
                var o = {
                    "M+": this.getMonth() + 1, //月份 
                    "d+": this.getDate(), //日 
                    "h+": this.getHours(), //小时 
                    "m+": this.getMinutes(), //分 
                    "s+": this.getSeconds(), //秒 
                    "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
                    "S": this.getMilliseconds() //毫秒 
                };
                if (/(y+)/.test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                }
                for (var k in o) {
                    if (new RegExp("(" + k + ")").test(fmt)) {
                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                    }
                }
                return fmt;
            }
        }
    </script>
</body>
</html>
